<!DOCTYPE html>
<html lang="en">
    <head>
        {% include "head_base.html" %}
        <title>Histórico</title>
    </head>
    <body>
        <div class="body-geral">
            {% include "navbar.html" %}
            <div class="container mt-5">
                <div class="d-flex flex-column flex-md-row align-items-center bg-light p-3 rounded-3 shadow-sm">
                    <form class="d-flex align-items-center flex-grow-1 w-100 mb-2 mb-md-0 me-md-3"
                          role="search">
                        <span class="material-symbols-outlined fs-1 me-2 text-muted">search</span>
                        <input class="w-100 input-busca"
                               type="text"
                               placeholder="Buscar moderador..."
                               aria-label="Buscar"
                               id="busca-moderador">
                    </form>
                    <div class="d-flex w-100 w-md-auto justify-content-between justify-content-md-end">
                        <button class="btn btn-outline-secondary d-flex align-items-center me-2 py-2 w-50 w-md-auto hover-scale "
                                type="button">
                            <i class="bi bi-funnel me-1 fs-4"></i>
                            Filtros
                        </button>
                        <button class="btn btn-primary d-flex botao hover-scale align-items-center py-2 fs-4 rounded-3 justify-content-center w-50 w-md-auto"
                                type="button">
                            <i class="bi bi-download me-3 text-center"></i>
                            Exportar
                        </button>
                    </div>
                </div>
            </div>
            <div class="container mt-5">
                <div class="bg-light p-3 rounded-3 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">Nome</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Cargo</th>
                                    <th scope="col">Status</th>
                                    <th scope="col"></th>
                                    <th scope="col"></th>
                                </tr>
                            </thead>
                            <tbody id="tabela-busca">
                                {% for moderador in moderadores.items %}
                                    <tr>
                                        <th scope="row">{{ moderador.id }}</th>
                                        <td>{{ moderador.nome }}</td>
                                        <td>{{ moderador.email }}</td>
                                        <td>
                                            {% if moderador.admin %}
                                                Administrador
                                            {% else %}
                                                Moderador
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if moderador.ativo %}
                                                <div class="fw-bold status-tabela-ativo d-flex justify-content-center text-white">Ativo</div>
                                            {% else %}
                                                <div class="fw-bold status-tabela-inativo d-flex justify-content-center text-white">Inativo</div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="modal fade" id="modalEditar" tabindex="-1">
                                                <div class="modal-dialog modal-dialog-centered">
                                                    <div class="modal-content">
                                                        <form id="formEditarModerador">
                                                            <input type="hidden" id="modalId">
                                                            <input type="text" id="modalNome" class="form-control mb-2">
                                                            <label>
                                                                <input type="checkbox" id="modalAdmin">
                                                                Admin
                                                            </label>
                                                            <label>
                                                                <input type="checkbox" id="modalAtivo">
                                                                Ativo
                                                            </label>
                                                            <button type="submit" class="btn btn-primary mt-2">Salvar</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="fw-bold alterar-senha-tabela d-flex justify-content-center text-white hover-scale">
                                                <i class="bi bi-lock"> Alterar senha</i>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <nav aria-label="page-navegation"
                 class="d-flex justify-content-center mt-3 mb-5">
                <ul class="pagination pagination-md d-flex gap-2">
                    <li class="page-item proximo-e-anterior hover-scale {% if not moderadores.has_prev %}disabled opacity-25 pe-none{% endif %}">
                        <a class="d-flex justify-content-center align-items-center w-100 h-100 text-decoration-none"
                           href="{{ url_for('admin.painel_ver_moderadores', pagina=moderadores.prev_num) if moderadores.has_prev else '#' }}">
                            <span class="fw-bold fs-6 text-black">Anterior</span>
                        </a>
                    </li>
                    <li class="page-item proximo-e-anterior hover-scale {% if not moderadores.has_next %}disabled opacity-25 pe-none{% endif %}">
                        <a class="d-flex justify-content-center align-items-center w-100 h-100 text-decoration-none"
                           href="{{ url_for('admin.painel_ver_moderadores', pagina=moderadores.next_num) if moderadores.has_next else '#' }}">
                            <span class="fw-bold fs-6 text-black">Próximo</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </body>
</html>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Pega todos os formulários de edição
  document.querySelectorAll(".form-update").forEach(form => {
    form.addEventListener("submit", async e => {
      e.preventDefault(); // impede a página de recarregar

      // Envia os dados do formulário para o servidor
      const resposta = await fetch(`/painel/admin/editar_moderador/${form.dataset.id}`, {
        method: "POST",
        body: new FormData(form)
      });

      const resultado = await resposta.json();
      console.log("Resposta do servidor:", resultado);

      // Fecha o modal
      bootstrap.Modal.getInstance(form.closest(".modal"))?.hide();

      // Atualiza a linha da tabela
      const linha = form.closest("tr");
      if (!linha) return;

      linha.children[1].textContent = resultado.nome; // coluna Nome
      linha.children[3].textContent = resultado.admin ? "Administrador" : "Moderador"; // coluna Permissão

      const status = linha.children[4].querySelector("div");
      if (status) {
        status.textContent = resultado.ativo ? "Ativo" : "Inativo";
        status.className = `fw-bold ${resultado.ativo ? "status-tabela-ativo" : "status-tabela-inativo"} d-flex justify-content-center text-white`;
      }
    });
  });
});






document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("busca-moderador");
  const tbody = document.getElementById("tabela-busca");
  const modal = new bootstrap.Modal(document.getElementById("modalEditar"));
  const formModal = document.getElementById("formEditarModerador");

  let timeout;

  // Função para preencher modal com dados da linha
  function preencherModal(tr) {
    document.getElementById("modalId").value = tr.dataset.id;
    document.getElementById("modalNome").value = tr.children[1].textContent;
    document.getElementById("modalAdmin").checked = tr.children[3].textContent === "Administrador";
    document.getElementById("modalAtivo").checked = tr.children[4].textContent === "Ativo";
  }

  // Clique no botão "Editar" dentro da tabela
  tbody.addEventListener("click", e => {
    const btn = e.target.closest(".botao-modal");
    if (!btn) return;
    const tr = btn.closest("tr");
    preencherModal(tr);
  });

  // Envio do formulário do modal
  formModal.addEventListener("submit", async e => {
    e.preventDefault();
    const formData = new FormData(formModal);
    const id = formModal.modalId.value;

    try {
      const res = await fetch(`/painel/admin/editar_moderador/${id}`, {
        method: "POST",
        body: formData
      });
      const r = await res.json();

      // Atualiza a linha correspondente na tabela
      const tr = tbody.querySelector(`tr[data-id="${r.id}"]`);
      if (tr) {
        tr.children[1].textContent = r.nome;
        tr.children[3].textContent = r.admin ? "Administrador" : "Moderador";
        tr.children[4].textContent = r.ativo ? "Ativo" : "Inativo";
        tr.children[4].className = `fw-bold ${r.ativo ? 'status-tabela-ativo' : 'status-tabela-inativo'} d-flex justify-content-center text-white`;
      }

      modal.hide();
    } catch (err) {
      console.error("Erro ao atualizar moderador:", err);
    }
  });

  // Busca com debounce
  input.addEventListener("input", () => {
    clearTimeout(timeout);
    timeout = setTimeout(async () => {
      const termo = input.value.trim();
      if (!termo) {
        tbody.innerHTML = "";
        return;
      }

      try {
        const lista = await (await fetch(`/painel/admin/buscar_moderadores?nome=${encodeURIComponent(termo)}`)).json();
        
        tbody.innerHTML = lista.map(m => `
          <tr data-id="${m.id}">
            <th>${m.id}</th>
            <td>${m.nome}</td>
            <td>${m.email}</td>
            <td>${m.admin ? "Administrador" : "Moderador"}</td>
            <td class="${m.ativo ? 'status-tabela-ativo' : 'status-tabela-inativo'} d-flex justify-content-center fw-bold text-white">
              ${m.ativo ? "Ativo" : "Inativo"}
            </td>
            <td>
              <button type="button" class="botao-modal btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalEditar">
                Editar
              </button>
            </td>
          </tr>
        `).join("");

      } catch (err) {
        console.error("Erro na busca:", err);
      }
    }, 500);
  });
});
</script>
